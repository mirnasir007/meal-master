<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>মেস মিল ম্যানেজার</title>
    <link rel="icon" type="image/png" href="logo.png">
    <meta name="theme-color" content="#007bff">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <style>
        :root {
            --primary-color: #007bff; --secondary-color: #6c757d; --background-color: #f4f7f9;
            --card-background: #ffffff; --text-color: #333333; --border-radius: 8px;
            --box-shadow: 0 4px 8px rgba(0,0,0,0.1); --loader-color: #007bff;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--background-color); margin: 0; padding-bottom: 80px; }
        header { background-color: var(--primary-color); color: white; padding: 15px 20px; text-align: center; font-size: 1.2em; }
        main { padding: 15px; }
        .page { display: none; }
        .page.active { display: block; }
        .card { background-color: var(--card-background); border-radius: var(--border-radius); padding: 20px; margin-bottom: 20px; box-shadow: var(--box-shadow); overflow-x: auto; }
        .card h3 { margin-top: 0; color: var(--primary-color); border-bottom: 2px solid #eee; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center; }
        .summary-item { background-color: #f8f9fa; padding: 15px; border-radius: var(--border-radius); }
        .summary-item .label { font-size: 0.9em; color: var(--secondary-color); }
        .summary-item .value { font-size: 1.5em; font-weight: bold; color: var(--primary-color); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: var(--border-radius); box-sizing: border-box; }
        .meal-input-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .meal-input-item { text-align: center; }
        .meal-input-item label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--primary-color); }
        .meal-input-item input { text-align: center; }
        button { width: 100%; padding: 15px; background-color: var(--primary-color); color: white; border: none; border-radius: var(--border-radius); font-size: 1em; cursor: pointer; transition: background-color 0.3s; margin-top: 10px; }
        button:disabled { background-color: #a0c9ff; cursor: not-allowed; }
        .btn-danger { background-color: #dc3545; }
        .btn-secondary { background-color: var(--secondary-color); }
        .month-filter { max-width: 180px; padding: 6px; font-size: 0.9em; border-radius: 4px; border: 1px solid #ddd; }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .history-table th, .history-table td { padding: 12px; border: 1px solid #ddd; text-align: center; }
        .history-table th { background-color: #f2f2f2; }
        .history-table .edit-btn { background: none; border: none; color: var(--primary-color); cursor: pointer; font-size: 1.1em; padding: 5px; }
        /* নতুন: শূন্য মিলের জন্য লাল ব্যাকগ্রাউন্ড */
        .history-table .no-meal { background-color: #ffebee; color: #c62828; font-weight: bold; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--card-background); box-shadow: 0 -2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-around; padding: 10px 0; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--secondary-color); text-decoration: none; font-size: 0.8em; }
        .nav-item i { font-size: 1.5em; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary-color); }
        .loader { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--loader-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none; }
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 12px 20px; border-radius: 25px; font-size: 0.9em; z-index: 1000; opacity: 0; transition: opacity 0.5s, bottom 0.5s; }
        .toast.show { opacity: 1; bottom: 100px; }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .rate-save-group { display: flex; align-items: center; gap: 10px; }
        .rate-save-group input { flex-grow: 1; }
        .rate-save-group button { width: auto; padding: 12px 20px; margin-top: 0; }
        .rate-history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px solid #eee; font-size: 0.95em; }
        .modal { position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; padding: 15px; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 100%; max-width: 500px; border-radius: var(--border-radius); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .modal-header h4 { margin: 0; color: var(--primary-color); }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

        /* মোবাইল ভিউ এর জন্য স্টাইল */
        @media screen and (max-width: 768px) {
            .history-table {
                font-size: 0.9em;
            }
            .history-table th, .history-table td {
                padding: 10px 4px;
                white-space: nowrap;
            }
            #dashboard .history-table td {
                white-space: normal;
            }
            .meal-input-grid {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 8px;
            }
            .meal-input-item label {
                font-size: 0.9em;
            }
            .meal-input-item input {
                padding: 10px;
                font-size: 0.9em;
            }
            .summary-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            .summary-item {
                padding: 10px;
            }
            .summary-item .value {
                font-size: 1.3em;
            }
        }

        /* খুব ছোট স্ক্রিনের জন্য */
        @media screen and (max-width: 480px) {
            .meal-input-grid {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 5px;
            }
            .meal-input-item label {
                font-size: 0.8em;
            }
            .meal-input-item input {
                padding: 8px;
                font-size: 0.8em;
            }
            .summary-grid {
                grid-template-columns: 1fr 1fr;
            }
            .summary-item .value {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>

    <header><h1>মেস ম্যানেজার</h1></header>

    <main id="app-content">
        <div id="loader" class="loader"></div>
        <div id="main-container" class="hidden">
            <section id="dashboard" class="page active">
                <div class="card">
                    <h3>ড্যাশবোর্ড <span id="dashboard-month-label"></span></h3>
                    <div class="summary-grid">
                        <div class="summary-item"><div class="label">মোট জমা</div><div class="value" id="dashboard-total-deposit">0</div></div>
                        <div class="summary-item"><div class="label">মোট খরচ</div><div class="value" id="dashboard-total-cost">0</div></div>
                        <div class="summary-item"><div class="label">মোট মিল</div><div class="value" id="dashboard-total-meals">0</div></div>
                        <div class="summary-item"><div class="label">অবশিষ্ট</div><div class="value" id="dashboard-balance">0</div></div>
                    </div>
                </div>
                 <div class="card">
                    <h3>মিল পরিসংখ্যান</h3>
                    <table class="history-table">
                        <tbody>
                            <tr><td>সকালের মিল</td><td id="dashboard-sokal">0</td></tr>
                            <tr><td>দুপুরের মিল</td><td id="dashboard-dupur">0</td></tr>
                            <tr><td>রাতের মিল</td><td id="dashboard-rat">0</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="add-mill" class="page">
                <div class="card">
                    <h3>নতুন মিল যোগ করুন</h3>
                    <form id="add-meal-form">
                        <div class="form-group">
                            <label for="meal-date">তারিখ</label>
                            <input type="date" id="meal-date" required>
                        </div>
                        <div class="form-group">
                            <label>মিলের পরিমাণ লিখুন</label>
                            <div class="meal-input-grid">
                                <div class="meal-input-item">
                                    <label for="meal-sokal">সকাল</label>
                                    <input type="number" id="meal-sokal" step="0.5" min="0" value="0" placeholder="0">
                                </div>
                                <div class="meal-input-item">
                                    <label for="meal-dupur">দুপুর</label>
                                    <input type="number" id="meal-dupur" step="0.5" min="0" value="0" placeholder="0">
                                </div>
                                <div class="meal-input-item">
                                    <label for="meal-rat">রাত</label>
                                    <input type="number" id="meal-rat" step="0.5" min="0" value="0" placeholder="0">
                                </div>
                            </div>
                        </div>
                        <button type="submit" id="add-meal-btn">সমস্ত মিল যোগ করুন</button>
                    </form>
                </div>
                <div class="card">
                    <h3><span>মিলের ইতিহাস</span><select id="meal-month-filter" class="month-filter"></select></h3>
                    <table class="history-table"><thead><tr><th>তারিখ</th><th>বার</th><th>সকাল</th><th>দুপুর</th><th>রাত</th><th>পদক্ষেপ</th></tr></thead><tbody id="meal-history-body"></tbody></table>
                </div>
            </section>

            <section id="add-deposit" class="page">
                 <div class="card">
                    <h3>টাকা জমা দিন</h3>
                    <form id="add-deposit-form"><div class="form-group"><label for="deposit-date">তারিখ</label><input type="date" id="deposit-date" required></div><div class="form-group"><label for="deposit-amount">টাকার পরিমাণ</label><input type="number" id="deposit-amount" min="0" required></div><button type="submit" id="add-deposit-btn">জমা দিন</button></form>
                </div>
                <div class="card">
                    <h3><span>জমার ইতিহাস</span><select id="deposit-month-filter" class="month-filter"></select></h3>
                    <table class="history-table"><thead><tr><th>তারিখ</th><th>বার</th><th>টাকার পরিমাণ</th></tr></thead><tbody id="deposit-history-body"></tbody></table>
                </div>
            </section>

            <section id="calculation" class="page">
                <div class="card">
                    <h3><span>মাসিক হিসাব</span><select id="calc-month-filter" class="month-filter"></select></h3>
                    <div class="form-group"><p><strong>মোট জমা:</strong> <span id="calc-total-deposit">0</span></p><p><strong>মোট মিল:</strong> <span id="calc-total-meals">0</span></p></div>
                    <form id="save-rate-form">
                        <div class="form-group">
                            <label for="meal-rate">মিল রেট (প্রতি মিল)</label>
                            <div class="rate-save-group">
                                <input type="number" id="meal-rate" step="0.01">
                                <button type="submit" id="save-rate-btn">সেভ করুন</button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="card"><h3>ফলাফল</h3><p><strong>মোট খরচ:</strong> <span id="calc-total-cost">0</span></p><p><strong>অবশিষ্ট টাকা:</strong> <span id="calc-remaining-balance">0</span></p></div>
                <div class="card">
                    <h3><span>পূর্ববর্তী মাসের হিসাব</span><select id="rate-history-month-filter" class="month-filter"></select></h3>
                    <div id="rate-history-container"></div>
                </div>
            </section>
        </div>
    </main>
    
    <div id="editMealModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>মিল এডিট করুন</h4>
                <span class="close-btn">&times;</span>
            </div>
            <form id="edit-meal-form">
                <input type="hidden" id="edit-original-date">
                <div class="form-group">
                    <label for="edit-meal-date">তারিখ</label>
                    <input type="date" id="edit-meal-date" required>
                </div>
                <div class="form-group">
                    <label>বার: <span id="edit-meal-day"></span></label>
                </div>
                <div class="modal-grid">
                    <div class="form-group"><label for="edit-meal-sokal">সকাল</label><input type="number" id="edit-meal-sokal" step="0.5" min="0" value="0"></div>
                    <div class="form-group"><label for="edit-meal-dupur">দুপুর</label><input type="number" id="edit-meal-dupur" step="0.5" min="0" value="0"></div>
                    <div class="form-group"><label for="edit-meal-rat">রাত</label><input type="number" id="edit-meal-rat" step="0.5" min="0" value="0"></div>
                </div>
                <button type="submit" id="update-meal-btn">আপডেট করুন</button>
                <button type="button" id="delete-meal-btn" class="btn-danger">এই দিনের মিল ডিলেট করুন</button>
            </form>
        </div>
    </div>

    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>আপনি কি নিশ্চিত?</h4>
                <span class="close-btn" id="close-confirm-modal">&times;</span>
            </div>
            <p id="confirm-modal-text" style="margin: 20px 0;">আপনি কি এই দিনের সমস্ত মিল ডিলেট করতে চান?</p>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                 <button type="button" id="cancel-delete-btn" class="btn-secondary">না</button>
                 <button type="button" id="confirm-delete-btn" class="btn-danger">হ্যাঁ, ডিলেট করুন</button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-page="dashboard"><i class="fas fa-chart-pie"></i><span>ড্যাশবোর্ড</span></a>
        <a href="#" class="nav-item" data-page="add-mill"><i class="fas fa-plus-circle"></i><span>অ্যাড মিল</span></a>
        <a href="#" class="nav-item" data-page="add-deposit"><i class="fas fa-wallet"></i><span>টাকা জমা</span></a>
        <a href="#" class="nav-item" data-page="calculation"><i class="fas fa-calculator"></i><span>হিসাব</span></a>
    </nav>
    <div id="toast" class="toast"></div>

    <script>
        const SCRIPT_URL = "AKfycbynzOuz5rCHJDMdllCQDGXgZQf1XhhC_VVcSWa6agx0B6C4xUE51LAQ2y7RxegFZdv-/exec";
        let allMeals = [], allDeposits = [], allRates = [];
        const BENGALI_DAYS = ["রবিবার", "সোমবার", "মঙ্গলবার", "বুধবার", "বৃহস্পতিবার", "শুক্রবার", "শনিবার"];
        const BENGALI_MONTHS = ["জানুয়ারি", "ফেব্রুয়ারি", "মার্চ", "এপ্রিল", "মে", "জুন", "জুলাই", "আগস্ট", "সেপ্টেম্বর", "অক্টোবর", "নভেম্বর", "ডিসেম্বর"];

        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            setDefaultDates();
            fetchData();
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(err => console.error("Service Worker registration failed:", err));
            }
        });

        function setupEventListeners() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', e => navigate(e, item.getAttribute('data-page')));
            });
            document.getElementById('add-meal-form').addEventListener('submit', handleAddMultipleMeals);
            document.getElementById('add-deposit-form').addEventListener('submit', handleAddDeposit);
            document.getElementById('save-rate-form').addEventListener('submit', handleSaveRate);
            
            document.getElementById('meal-month-filter').addEventListener('change', e => displayMealHistory(e.target.value));
            document.getElementById('deposit-month-filter').addEventListener('change', e => displayDepositHistory(e.target.value));
            document.getElementById('calc-month-filter').addEventListener('change', e => updateCalculationPage(e.target.value));
            document.getElementById('rate-history-month-filter').addEventListener('change', e => displayRateHistory(e.target.value));
            document.getElementById('meal-rate').addEventListener('input', () => updateCalculationPage(document.getElementById('calc-month-filter').value));

            // Modal listeners
            const editModal = document.getElementById('editMealModal');
            editModal.querySelector('.close-btn').addEventListener('click', () => editModal.style.display = 'none');
            window.addEventListener('click', e => { if (e.target == editModal) editModal.style.display = 'none'; });
            document.getElementById('edit-meal-form').addEventListener('submit', handleUpdateMeal);
            document.getElementById('delete-meal-btn').addEventListener('click', handleDeleteMeals);
            document.getElementById('edit-meal-date').addEventListener('change', updateEditDay);
        }

        function navigate(e, pageId) {
            e.preventDefault();
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            e.currentTarget.classList.add('active');
            if (pageId === 'dashboard') updateDashboard(getCurrentMonthYear());
            if (pageId === 'calculation') updateCalculationPage(document.getElementById('calc-month-filter').value);
        }

        function setDefaultDates() {
            const today = new Date();
            // Bangladesh timezone অনুযায়ী তারিখ সেট করা
            const bangladeshOffset = 6 * 60 * 60 * 1000; // UTC+6 in milliseconds
            const bangladeshTime = new Date(today.getTime() + bangladeshOffset);
            const todayStr = bangladeshTime.toISOString().split('T')[0];
            
            document.getElementById('meal-date').value = todayStr;
            document.getElementById('deposit-date').value = todayStr;
        }

        async function fetchData() {
            showLoader(true);
            try {
                const response = await fetch(`https://script.google.com/macros/s/${SCRIPT_URL}`);
                if (!response.ok) throw new Error('Network response error.');
                const data = await response.json();
                allMeals = data.meals || [];
                allDeposits = data.deposits || [];
                allRates = (data.monthlyRates || []).map(rate => {
                    if (rate.MonthYear && typeof rate.MonthYear === 'string' && rate.MonthYear.includes('T')) {
                        const date = new Date(rate.MonthYear);
                        rate.MonthYear = `${date.getFullYear()}-${('0' + (date.getMonth() + 1)).slice(-2)}`;
                    }
                    return rate;
                });
                initializeApp();
            } catch (error) {
                console.error("Fetch error:", error);
                showToast('ডেটা লোড করা যায়নি।', 'error');
            } finally {
                showLoader(false);
            }
        }

        function initializeApp() {
            const currentMonthYear = getCurrentMonthYear();
            generateMonthFilters(currentMonthYear);
            displayMealHistory(document.getElementById('meal-month-filter').value || currentMonthYear);
            displayDepositHistory(document.getElementById('deposit-month-filter').value || currentMonthYear);
            updateDashboard(currentMonthYear);
            updateCalculationPage(document.getElementById('calc-month-filter').value || currentMonthYear);
            displayRateHistory();
        }
        
        function generateMonthFilters(selectedMonthYear) {
            const filters = document.querySelectorAll('.month-filter');
            const allMonthYears = [...new Set([
                getCurrentMonthYear(),
                ...allMeals.map(m => {
                    const mealDate = parseDate(m.Date);
                    return mealDate.toISOString().substring(0, 7);
                }),
                ...allDeposits.map(d => {
                    const depositDate = parseDate(d.Date);
                    return depositDate.toISOString().substring(0, 7);
                }),
                ...allRates.map(r => r.MonthYear) 
            ])].filter(Boolean).sort().reverse();

            filters.forEach(filter => {
                const savedValue = filter.value;
                filter.innerHTML = '';
                if (filter.id === 'rate-history-month-filter') {
                    filter.innerHTML = '<option value="all">সব মাস</option>';
                }
                allMonthYears.forEach(monthYear => {
                    filter.innerHTML += `<option value="${monthYear}">${formatMonthYear(monthYear)}</option>`;
                });
                filter.value = savedValue || selectedMonthYear;
                 if (filter.id === 'rate-history-month-filter' && savedValue) filter.value = savedValue;
            });
        }
        
        function displayMealHistory(monthYear) {
            const tbody = document.getElementById('meal-history-body');
            tbody.innerHTML = '';
            const mealsByDate = allMeals.filter(meal => {
                const mealDate = parseDate(meal.Date);
                return mealDate.toISOString().startsWith(monthYear);
            })
            .reduce((acc, meal) => {
                const mealDate = parseDate(meal.Date);
                const date = mealDate.toISOString().split('T')[0];
                if (!acc[date]) acc[date] = { sokal: 0, dupur: 0, rat: 0 };
                acc[date][meal.MealTime] = (acc[date][meal.MealTime] || 0) + parseFloat(meal.Count);
                return acc;
            }, {});

            Object.keys(mealsByDate).sort().reverse().forEach(dateStr => {
                const date = parseDate(dateStr);
                const { sokal = 0, dupur = 0, rat = 0 } = mealsByDate[dateStr];
                const row = document.createElement('tr');
                
                // নতুন: সব মিল ০ হলে লাল ব্যাকগ্রাউন্ড ক্লাস যোগ করুন
                const isNoMealDay = sokal === 0 && dupur === 0 && rat === 0;
                if (isNoMealDay) {
                    row.className = 'no-meal';
                }
                
                row.innerHTML = `
                    <td>${formatDate(date)}</td>
                    <td>${BENGALI_DAYS[date.getDay()]}</td>
                    <td>${sokal}</td>
                    <td>${dupur}</td>
                    <td>${rat}</td>
                    <td><button class="edit-btn"><i class="fas fa-edit"></i></button></td>`;
                row.querySelector('.edit-btn').addEventListener('click', () => openEditModal(dateStr, mealsByDate[dateStr]));
                tbody.appendChild(row);
            });
        }

        function displayDepositHistory(monthYear) {
            const tbody = document.getElementById('deposit-history-body');
            tbody.innerHTML = '';
            allDeposits.filter(d => {
                const depositDate = parseDate(d.Date);
                return depositDate.toISOString().startsWith(monthYear);
            })
            .sort((a,b) => new Date(b.Date) - new Date(a.Date))
            .forEach(d => {
                const date = parseDate(d.Date);
                tbody.innerHTML += `<tr><td>${formatDate(date)}</td><td>${BENGALI_DAYS[date.getDay()]}</td><td>${formatNumber(d.Amount)}</td></tr>`;
            });
        }
        
        function updateDashboard(monthYear) {
            document.getElementById('dashboard-month-label').textContent = formatMonthYear(monthYear);
            const meals = allMeals.filter(m => {
                const mealDate = parseDate(m.Date);
                return mealDate.toISOString().startsWith(monthYear);
            });
            const deposits = allDeposits.filter(d => {
                const depositDate = parseDate(d.Date);
                return depositDate.toISOString().startsWith(monthYear);
            });
            const rateInfo = allRates.find(r => r.MonthYear == monthYear);
            const mealRate = rateInfo ? parseFloat(rateInfo.MealRate) : 0;
            const totalDeposit = deposits.reduce((sum, d) => sum + parseFloat(d.Amount), 0);
            const totalMeals = meals.reduce((sum, m) => sum + parseFloat(m.Count), 0);
            const totalCost = totalMeals * mealRate;
            
            document.getElementById('dashboard-total-deposit').textContent = formatNumber(totalDeposit);
            document.getElementById('dashboard-total-meals').textContent = totalMeals.toFixed(1);
            document.getElementById('dashboard-total-cost').textContent = formatNumber(totalCost);
            document.getElementById('dashboard-balance').textContent = formatNumber(totalDeposit - totalCost);
            
            document.getElementById('dashboard-sokal').textContent = meals.filter(m => m.MealTime === 'sokal').reduce((s, m) => s + parseFloat(m.Count), 0).toFixed(1);
            document.getElementById('dashboard-dupur').textContent = meals.filter(m => m.MealTime === 'dupur').reduce((s, m) => s + parseFloat(m.Count), 0).toFixed(1);
            document.getElementById('dashboard-rat').textContent = meals.filter(m => m.MealTime === 'rat').reduce((s, m) => s + parseFloat(m.Count), 0).toFixed(1);
        }
        
        function updateCalculationPage(monthYear) {
            const meals = allMeals.filter(m => {
                const mealDate = parseDate(m.Date);
                return mealDate.toISOString().startsWith(monthYear);
            });
            const deposits = allDeposits.filter(d => {
                const depositDate = parseDate(d.Date);
                return depositDate.toISOString().startsWith(monthYear);
            });
            const totalDeposit = deposits.reduce((sum, d) => sum + parseFloat(d.Amount), 0);
            const totalMeals = meals.reduce((sum, m) => sum + parseFloat(m.Count), 0);
            
            const rateInfo = allRates.find(r => r.MonthYear == monthYear);
            const savedRate = rateInfo ? parseFloat(rateInfo.MealRate) : '';
            const currentRateInput = document.getElementById('meal-rate');
            const currentRate = parseFloat(currentRateInput.value) || (savedRate || 0);
            
            if (document.activeElement !== currentRateInput) {
                currentRateInput.value = savedRate;
            }

            const totalCost = totalMeals * currentRate;

            document.getElementById('calc-total-deposit').textContent = formatNumber(totalDeposit);
            document.getElementById('calc-total-meals').textContent = totalMeals.toFixed(1);
            document.getElementById('calc-total-cost').textContent = formatNumber(totalCost);
            document.getElementById('calc-remaining-balance').textContent = formatNumber(totalDeposit - totalCost);
        }

        function displayRateHistory(selectedMonth = 'all') {
            const container = document.getElementById('rate-history-container');
            container.innerHTML = '';
            let ratesToDisplay = (selectedMonth === 'all') ? allRates : allRates.filter(r => r.MonthYear === selectedMonth);
            if (ratesToDisplay.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--secondary-color);">এই মাসের কোনো হিসাব নেই।</p>';
                return;
            }
            ratesToDisplay.sort((a, b) => b.MonthYear.localeCompare(a.MonthYear)).forEach(rateInfo => {
                const totalMeals = allMeals.filter(m => {
                    const mealDate = parseDate(m.Date);
                    return mealDate.toISOString().startsWith(rateInfo.MonthYear);
                }).reduce((sum, m) => sum + parseFloat(m.Count), 0);
                const mealRate = parseFloat(rateInfo.MealRate) || 0;
                container.innerHTML += `<div class="rate-history-item">
                    <div><strong>${formatMonthYear(rateInfo.MonthYear)}</strong><br><span>মোট মিল: ${totalMeals.toFixed(1)}</span></div>
                    <div><strong>${formatNumber(totalMeals * mealRate)}</strong><br><span>রেট: ${mealRate.toFixed(2)}</span></div>
                </div>`;
            });
        }
        
        // --- Form Handlers ---
        async function handleAddMultipleMeals(e) {
            e.preventDefault();
            const sokal = parseFloat(document.getElementById('meal-sokal').value) || 0;
            const dupur = parseFloat(document.getElementById('meal-dupur').value) || 0;
            const rat = parseFloat(document.getElementById('meal-rat').value) || 0;
            
            // পুরাতন ভ্যালিডেশন রিমুভ করা হয়েছে - এখন সব মিল ০ হলেও সেভ হবে
            const data = {
                action: "addMultipleMeals", 
                date: document.getElementById('meal-date').value,
                sokal: sokal,
                dupur: dupur,
                rat: rat
            };
            
            await submitFormData(e.target, 'add-meal-btn', data, 'সমস্ত মিল যোগ করা হয়েছে!', 'মিল যোগ করতে ব্যর্থ।');
            await fetchData();
        }

        async function handleAddDeposit(e) {
            e.preventDefault();
            const data = { action: "addDeposit", date: document.getElementById('deposit-date').value, amount: document.getElementById('deposit-amount').value };
            await submitFormData(e.target, 'add-deposit-btn', data, 'টাকা জমা হয়েছে!', 'টাকা জমা করতে ব্যর্থ।');
            await fetchData();
        }
        
        async function handleSaveRate(e) {
            e.preventDefault();
            const rateValue = document.getElementById('meal-rate').value;
            if (!rateValue) { showToast('দয়া করে মিল রেট লিখুন।', 'error'); return; }
            const data = { action: "saveMealRate", monthYear: document.getElementById('calc-month-filter').value, MealRate: rateValue };
            await submitFormData(e.target, 'save-rate-btn', data, 'মিল রেট সেভ হয়েছে!', 'মিল রেট সেভ করতে ব্যর্থ।', false);
            await fetchData();
        }

        async function handleUpdateMeal(e) {
            e.preventDefault();
            const data = {
                action: "updateMeal",
                originalDate: document.getElementById('edit-original-date').value,
                newDate: document.getElementById('edit-meal-date').value,
                sokal: parseFloat(document.getElementById('edit-meal-sokal').value) || 0,
                dupur: parseFloat(document.getElementById('edit-meal-dupur').value) || 0,
                rat: parseFloat(document.getElementById('edit-meal-rat').value) || 0,
            };
            await submitFormData(e.target, 'update-meal-btn', data, 'মিল আপডেট করা হয়েছে!', 'মিল আপডেট করতে ব্যর্থ।', false);
            document.getElementById('editMealModal').style.display = 'none';
            await fetchData();
        }

        async function handleDeleteMeals(e) {
            e.preventDefault();
            const modal = document.getElementById('deleteConfirmModal');
            modal.style.display = 'flex';

            document.getElementById('confirm-delete-btn').onclick = async () => {
                modal.style.display = 'none';
                const data = { action: "deleteMeal", date: document.getElementById('edit-original-date').value };
                
                await submitFormData(document.getElementById('edit-meal-form'), 'delete-meal-btn', data, 'মিল ডিলেট করা হয়েছে!', 'মিল ডিলেট করতে ব্যর্থ।', false);
                
                document.getElementById('editMealModal').style.display = 'none';
                await fetchData();
            };

            const closeModal = () => modal.style.display = 'none';
            document.getElementById('cancel-delete-btn').onclick = closeModal;
            document.getElementById('close-confirm-modal').onclick = closeModal;
            window.addEventListener('click', e => { if (e.target == modal) closeModal(); }, { once: true });
        }
        
        async function submitFormData(form, btnId, data, successMsg, errorMsg, shouldReset = true) {
            const btn = document.getElementById(btnId);
            const originalBtnText = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = 'পাঠানো হচ্ছে...';
            try {
                await postData(data);
                showToast(successMsg, 'success');
                if (shouldReset) { 
                    form.reset(); 
                    setDefaultDates(); 
                    // Reset meal inputs to 0
                    document.getElementById('meal-sokal').value = 0;
                    document.getElementById('meal-dupur').value = 0;
                    document.getElementById('meal-rat').value = 0;
                }
            } catch (error) {
                showToast(errorMsg, 'error');
                console.error("Submit error:", error);
            } finally {
                btn.disabled = false; btn.innerHTML = originalBtnText;
            }
        }

        async function postData(data) {
             const response = await fetch(`https://script.google.com/macros/s/${SCRIPT_URL}`, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }

        // --- UI & Helper Functions ---
        function openEditModal(dateStr, meals) {
            document.getElementById('edit-original-date').value = dateStr;
            document.getElementById('edit-meal-date').value = dateStr;
            document.getElementById('edit-meal-sokal').value = meals.sokal || 0;
            document.getElementById('edit-meal-dupur').value = meals.dupur || 0;
            document.getElementById('edit-meal-rat').value = meals.rat || 0;
            updateEditDay();
            document.getElementById('editMealModal').style.display = 'flex';
        }

        function updateEditDay() {
            const date = new Date(document.getElementById('edit-meal-date').value);
            document.getElementById('edit-meal-day').textContent = BENGALI_DAYS[date.getDay()];
        }

        // তারিখ পার্স করার ফাংশন (Bangladesh timezone অনুযায়ী)
        function parseDate(dateStr) {
            const date = new Date(dateStr);
            // বাংলাদেশ টাইমজোন এডজাস্টমেন্ট (UTC+6)
            const bangladeshOffset = 6 * 60 * 60 * 1000; // UTC+6 in milliseconds
            const bangladeshTime = new Date(date.getTime() + bangladeshOffset);
            return bangladeshTime;
        }

        function showLoader(isLoading) {
            document.getElementById('loader').style.display = isLoading ? 'block' : 'none';
            document.getElementById('main-container').classList.toggle('hidden', isLoading);
        }
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => { toast.className = 'toast'; }, 3000);
        }
        function getCurrentMonthYear() { 
            const now = new Date();
            const bangladeshOffset = 6 * 60 * 60 * 1000; // UTC+6 in milliseconds
            const bangladeshTime = new Date(now.getTime() + bangladeshOffset);
            return bangladeshTime.toISOString().substring(0, 7); 
        }
        function formatMonthYear(my) { 
            const d = new Date(my + '-02'); 
            return `${BENGALI_MONTHS[d.getMonth()]} ${d.toLocaleDateString('bn-BD',{year:'numeric'})}`; 
        }
        function formatDate(d) { 
            if (typeof d === 'string') {
                d = parseDate(d);
            }
            return d.toLocaleDateString('bn-BD',{day:'2-digit',month:'2-digit',year:'2-digit'}); 
        }
        function formatNumber(num) { 
            return (num % 1 === 0 ? num.toFixed(0) : num.toFixed(2)).toLocaleString('bn-BD'); 
        }

    </script>
</body>
</html>
